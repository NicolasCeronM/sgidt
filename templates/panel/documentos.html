{% extends 'base_app.html' %} {% load static %} {% block title %}Documentos ·
SGIDT{% endblock %} {% block content %} {% block css %}
<link
  rel="stylesheet"
  href="{% static 'documentos/css/documentos.css' %}?v=4"
/>
{% endblock %}

<div id="pageProgress" class="page-progress" aria-hidden="true"></div>

<div id="toastContainer" class="toast-container"></div>

<section class="docs-page" aria-labelledby="docs-title">
  <div class="docs-container">
    <header class="page-header">
      <h1 id="docs-title" class="docs-title">Gestión de Documentos</h1>

      <div class="page-actions" style="display:flex; gap:10px; align-items:center;">
        <button
          id="btnToggleUpload"
          class="btn btn-primary"
          aria-expanded="false"
          aria-controls="uploadContainer"
        >
          <i class="fas fa-plus" aria-hidden="true"></i>
          <span>Subir Documento</span>
        </button>

        <button
          id="btnScanMail"
          class="btn btn-scan btn-primary"
          aria-expanded="false"
          aria-pressed="false"
          aria-label="Buscar documentos en correo"
          style="display:inline-flex;align-items:center;gap:10px;padding:10px 16px;border-radius:8px;background:linear-gradient(90deg,#0b74de,#0459a8);color:#ffffff;border:0;box-shadow:0 6px 18px rgba(4,41,84,0.18);transition:transform .14s ease,box-shadow .14s ease,filter .14s ease;cursor:pointer;font-weight:600;font-size:14px;"
          onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 12px 28px rgba(4,41,84,0.22)'; this.style.filter='brightness(1.03)';"
          onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 6px 18px rgba(4,41,84,0.18)'; this.style.filter='none';"
        >
          <span class="icon" aria-hidden="true" style="display:inline-flex;align-items:center;font-size:15px;">
            <i class="fas fa-envelope-open-text" style="width:20px;text-align:center;"></i>
          </span>
          <span class="label" style="font-weight:700;font-size:15px;">Buscar en Mail</span>
          <span class="sr-only" aria-hidden="true" style="width:0;height:0;overflow:hidden;">.</span>
          <span class="spinner" hidden aria-hidden="true" style="margin-left:6px;">
            <i class="fas fa-spinner fa-spin"></i>
          </span>
        </button>
      </div>
    </header>


    <div id="uploadContainer" class="upload-container" hidden>
      <section class="card upload-card" aria-labelledby="up-title">
        <h2 id="up-title" class="card-title-hidden">Subir Nuevo Documento</h2>

        <div
          id="uploadArea"
          class="upload-area"
          role="group"
          tabindex="0"
          aria-describedby="drop-hint"
        >
          <i class="fas fa-cloud-upload-alt" aria-hidden="true"></i>
          <p class="dz-title">
            Arrastra archivos aquí o haz clic para seleccionar
          </p>
          <p id="drop-hint" class="upload-hint">
            PDF, JPG, PNG (máx. 10MB por archivo)
          </p>
        </div>

        <input
          type="file"
          id="fileInput"
          multiple
          hidden
          accept=".pdf,.jpg,.jpeg,.png"
        />

        <div class="upload-actions">
          <button id="btnSelect" class="btn btn-secondary">
            <i class="fas fa-search" aria-hidden="true"></i>
            Seleccionar Archivos
          </button>
        </div>

        <ul id="queue" class="upload-queue" hidden aria-live="polite"></ul>
      </section>
    </div>

    <section class="card filters" aria-labelledby="filter-title">
      <h2 id="filter-title" class="card-title">Filtrar Documentos</h2>
      <div class="filters-grid">
        <div class="f-item">
          <label for="filterDateFrom">Desde</label>
          <div class="f-input">
            <i class="fas fa-calendar-alt" aria-hidden="true"></i>
            <input type="date" id="filterDateFrom" class="form-control" />
          </div>
        </div>
        <div class="f-item">
          <label for="filterDateTo">Hasta</label>
          <div class="f-input">
            <i class="fas fa-calendar-alt" aria-hidden="true"></i>
            <input type="date" id="filterDateTo" class="form-control" />
          </div>
        </div>
        <div class="f-item">
          <label for="filterType">Tipo</label>
          <div class="f-input">
            <i class="fas fa-file-alt" aria-hidden="true"></i>
            <select id="filterType" class="form-control">
              <option value="">Todos</option>
              <option value="factura_afecta">Factura Afecta</option>
              <option value="factura_exenta">Factura Exenta</option>
              <option value="nota_credito">Nota de Crédito</option>
              <option value="boleta_honorarios">Boleta Honorarios</option>
              <option value="otro">Otro</option>
            </select>
          </div>
        </div>
        <div class="f-item">
          <label for="filterStatus">Estado</label>
          <div class="f-input">
            <i class="fas fa-tasks" aria-hidden="true"></i>
            <select id="filterStatus" class="form-control">
              <option value="">Todos</option>
              <option value="procesado">Procesado</option>
              <option value="pendiente">Pendiente</option>
              <option value="error">Error</option>
            </select>
          </div>
        </div>
        <div class="f-actions">
          <button id="btnFilter" class="btn btn-primary">
            <i class="fas fa-filter" aria-hidden="true"></i>
            Filtrar
          </button>
        </div>
      </div>
      <p id="result-info" class="result-info" aria-live="polite"></p>
    </section>

    <section class="card table-card" aria-labelledby="table-title">
      <h2 id="table-title" class="card-title-hidden">Lista de Documentos</h2>
      <div class="table-wrap">
        <table id="documentsTable" class="table">
          <thead>
            <tr>
              <th>Fecha Emisión</th>
              <th>Tipo</th>
              <th>Folio</th>
              <th>RUT Proveedor</th>
              <th>Razón Social</th>
              <th class="num">Total</th>
              <th>Estado</th>
              <th>Estado SII</th>
              <th class="actions">Acciones</th>
            </tr>
          </thead>
          <tbody id="documentsTableBody"></tbody>
        </table>
      </div>

      <div id="tbl-skeleton" class="table-skeleton" aria-hidden="true">
        <div></div>
        <div></div>
        <div></div>
        <div></div>
      </div>

      <div id="tbl-empty" class="empty" hidden>
        <i class="fas fa-folder-open empty-illu" aria-hidden="true"></i>
        <p class="empty-text">No se encontraron documentos.</p>
        <p class="empty-text-secondary">
          ¿Por qué no
          <a href="#" id="empty-upload" class="empty-link">subes uno ahora</a>?
        </p>
      </div>
    </section>
  </div>
</section>

<div id="docDetailOverlay" class="modal-overlay" aria-hidden="true">
  <div
    class="modal"
    role="dialog"
    aria-modal="true"
    aria-labelledby="docDetailTitle"
    tabindex="-1"
  >
    <button class="modal-close-icon" id="docDetailClose" aria-label="Cerrar">
      <i class="fa-solid fa-xmark"></i>
    </button>

    <div class="modal-body">
      <div id="docDetailContent">
        <div class="kv-skel">
          <div class="skeleton"></div>
          <div class="skeleton"></div>
          <div class="skeleton"></div>
          <div class="skeleton"></div>
          <div class="skeleton"></div>
          <div class="skeleton"></div>
        </div>
      </div>
    </div>

    <div class="modal-actions">
      <a
        id="docViewBtn"
        class="btn-min"
        href="#"
        target="_blank"
        rel="noopener"
        hidden
        ><i class="fa-solid fa-eye"></i> Ver archivo</a
      >
      <a id="docDownloadBtn" class="btn-min" href="#" download hidden
        ><i class="fa-solid fa-download"></i> Descargar</a
      >
      <span id="docEstadoPill" class="pill" hidden></span>
      <span id="docSiiPill" class="pill" hidden></span>
    </div>
  </div>
</div>

{% endblock %} {% block js %}
<script type="module" src="{% static 'documentos/js/main.js' %}?v=2"></script>
<script>
  // Agregar esto en tu JS (ej: static/documentos/js/main.js o al final del html)

document.addEventListener('DOMContentLoaded', function() {
    const btnScan = document.getElementById('btnScanMail');
    
    if (btnScan) {
        btnScan.addEventListener('click', function() {
            // 1. UI Feedback: Deshabilitar botón y poner spinner
            const originalContent = btnScan.innerHTML;
            btnScan.disabled = true;
            btnScan.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Buscando...';

            // 2. Llamada Fetch al backend
            fetch('/correo/trigger-scan/', {
                method: 'POST',
                headers: {  
                    'X-CSRFToken': getCookie('csrftoken'), // Asegúrate de tener esta función de Django docs
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    // Éxito: Mostrar Toast y recargar tabla
                    showToast("success", data.message); // Asumiendo que tienes una función showToast
                    
                    // Opcional: Recargar la tabla de documentos automáticamente después de unos segundos
                    setTimeout(() => {
                        // Si tienes una función para recargar la tabla, úsala aquí.
                        // Ej: loadDocumentos(); 
                        // O si no, reload simple:
                        window.location.reload();
                    }, 3000); 
                } else {
                    showToast("error", "Error: " + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast("error", "Ocurrió un error al conectar con el servidor.");
            })
            .finally(() => {
                // 3. Restaurar botón después de unos segundos (para evitar spam de clicks)
                setTimeout(() => {
                    btnScan.innerHTML = originalContent;
                    btnScan.disabled = false;
                }, 2000);
            });
        });
    }
});

// Función auxiliar para obtener el CSRF token (estándar de Django)
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
