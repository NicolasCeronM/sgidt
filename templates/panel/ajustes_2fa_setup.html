{% extends "base_app.html" %}
{% load static %}

{% block title %}{{ page_title|default:"Configurar 2FA" }} · SGIDT{% endblock %}

{% block css %}
<link rel="stylesheet" href="{% static 'panel/css/ajustes.css' %}?v={% now 'U' %}">
{% endblock %}

{% block content %}
<div class="ajustes-page">
  <div class="settings-wrap">
    
    <div class="settings-header">
      <h1 class="settings-title">Configuración de Autenticación de Dos Factores</h1>
      <div class="settings-title-underline"></div>
      <p class="settings-subtitle">
        Sigue los pasos para proteger tu cuenta con una capa extra de seguridad.
      </p>
    </div>

    <div class="row settings-layout">
      
      <div class="col-12 settings-content-col">
        
        {% if messages %}
        <div class="messages-stack mb-3">
          {% for message in messages %}
          <div class="alert alert-{{ message.tags|default:'info' }}">{{ message }}</div>
          {% endfor %}
        </div>
        {% endif %}

        <div class="settings-section row">
            <div class="col-md-4 settings-section-info">
                <h4>Paso 1: Escanear Código QR</h4>
                <p>Usa una aplicación de autenticación (como Google Authenticator, Authy o Microsoft Authenticator) para escanear el código. Esto vinculará tu cuenta a la aplicación.</p>
            </div>
            <div class="col-md-8 settings-section-content">
                <div class="card">
                    <div class="card-body p-4 text-center">
                        {% if totp_uri %}
                            <img id="qr-code-img" 
                                 src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data={{ totp_uri|urlencode }}" 
                                 alt="Código QR 2FA" 
                                 style="border: 4px solid var(--color-border); border-radius: 4px; padding: 5px;">
                            
                            <p class="mt-4 settings-help">Si no puedes escanear, introduce esta clave manualmente (sensible a mayúsculas):</p>
                            <code class="d-inline-block p-2 bg-light rounded" 
                                  style="font-size: 1rem; color: var(--color-text-primary); border: 1px solid var(--color-border); font-weight: bold;">{{ secret }}</code>
                        {% else %}
                            <p class="text-danger">No se pudo generar el código QR. Recarga la página.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="settings-section row">
            <div class="col-md-4 settings-section-info">
                <h4>Paso 2: Verificar Código</h4>
                <p>Una vez que el código QR es escaneado, introduce el código de 6 dígitos que aparece en la aplicación para confirmar que la configuración es correcta.</p>
            </div>
            <div class="col-md-8 settings-section-content">
                <div class="card">
                    <form method="post" class="settings-form">
                        {% csrf_token %}
                        <div class="card-body p-4">
                            <div class="settings-row">
                                <div class="settings-label">Código de 6 dígitos</div>
                                <div class="settings-field">
                                    <input class="form-control" type="text" name="2fa_code" maxlength="6" pattern="\d{6}" inputmode="numeric" required placeholder="Ej: 123456">
                                    <div class="settings-help">El código cambia cada 30 segundos.</div>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer settings-actions">
                            <a href="{% url 'panel:ajustes_privacidad' %}" class="btn btn-secondary">Cancelar</a>
                            <button class="btn btn-primary" type="submit">Activar 2FA y Finalizar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

      </div>

    </div> 
  </div>
</div>
{% endblock %}