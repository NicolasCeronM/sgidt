{% extends "base_public.html" %}
{% load static %}

{% block title %}Iniciar Sesión - SGIDT{% endblock %}

{% block css %}
<link rel="stylesheet" href="{% static 'usuarios/css/login.css' %}">
<style>
    .alert-2fa {
        background-color: #e3f2fd;
        color: #0d47a1;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
        text-align: center;
        border: 1px solid #bbdefb;
    }
    .alert-2fa i {
        font-size: 1.5rem;
        display: block;
        margin-bottom: 0.5rem;
    }
    .trust-device-option {
        display: flex;
        align-items: center;
        margin-bottom: 1.5rem;
        font-size: 0.9rem;
        color: #555;
    }
    .trust-device-option input {
        margin-right: 8px;
        width: 16px;
        height: 16px;
        accent-color: #0d47a1;
    }
</style>
{% endblock %}

{% block content %}
<div class="login-container">
  <h1 class="login-title">Accede a tu cuenta</h1>
  <p class="login-subtitle">Gestión inteligente de documentos tributarios</p>

  {% if form.non_field_errors %}
  <div class="error-message" role="alert" style="display:block">
    {% for err in form.non_field_errors %}
    {{ err }}{% if not forloop.last %}<br>{% endif %}
    {% endfor %}
  </div>
  {% endif %}

  <form method="post" id="loginForm" novalidate>
    {% csrf_token %}
    {% if next %}<input type="hidden" name="next" value="{{ next }}">{% endif %}

    {% if requires_2fa %}
        <div class="alert-2fa">
            <i class="fas fa-shield-alt"></i> 
            <strong>Verificación en dos pasos</strong><br>
            Ingresa el código de tu aplicación autenticadora.
        </div>

        <div style="display:none;">
            {{ form.username.as_hidden }}
            {{ form.password.as_hidden }}
        </div>

        <div class="form-group">
            <label for="{{ form.otp_code.id_for_label }}" class="form-label">Código de Verificación</label>
            {{ form.otp_code }}
            {% if form.otp_code.errors %}
            <div class="field-error">
                {% for err in form.otp_code.errors %}
                {{ err }}{% if not forloop.last %}<br>{% endif %}
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <div class="trust-device-option">
            {{ form.trust_device }}
            <label for="{{ form.trust_device.id_for_label }}">{{ form.trust_device.label }}</label>
        </div>

        <button type="submit" class="btn-login">Verificar Código</button>
        
        <div style="text-align:center; margin-top:1rem;">
            <a href="{% url 'usuarios:login' %}" style="font-size:0.9rem; color:#666;">Cancelar / Volver</a>
        </div>

    {% else %}
        <div class="form-group">
          <label for="{{ form.username.id_for_label }}" class="form-label">Correo o RUT</label>
          {{ form.username }}
          {% if form.username.errors %}
          <div class="field-error">
            {% for err in form.username.errors %}
            {{ err }}{% if not forloop.last %}<br>{% endif %}
            {% endfor %}
          </div>
          {% endif %}
        </div>

        <div class="form-group password-group">
          <label for="{{ form.password.id_for_label }}" class="form-label">Contraseña</label>
          <div class="password-wrapper">
            {{ form.password }}
            <button type="button" class="toggle-password" aria-label="Mostrar u ocultar contraseña">
              <i class="far fa-eye"></i>
            </button>
          </div>
          {% if form.password.errors %}
          <div class="field-error">
            {% for err in form.password.errors %}
            {{ err }}{% if not forloop.last %}<br>{% endif %}
            {% endfor %}
          </div>
          {% endif %}
        </div>

        <div class="form-checkbox">
          <div class="remember-box">
            <input type="checkbox" id="remember" name="remember">
            <label for="remember">Recordarme</label>
          </div>

          <a href="{% url 'usuarios:password_reset_request' %}" class="link-forgot">¿Olvidaste tu contraseña?</a>
        </div>

        <button type="submit" class="btn-login">
          Iniciar Sesión
        </button>
        
        <div class="divider"><span>o</span></div>

        <p class="register-link">
            ¿No tienes cuenta?
        </p>
        <p class="register-link" style="margin-top:.5rem;">
            ¿Eres empresa?
            <a href="{% url 'empresas:registro_pyme-legacy' %}">Registrar empresa / PYME</a>
        </p>

    {% endif %}
  </form>
</div>
{% endblock %}

{% block js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
<script>
  (function () {
    const toggle = document.querySelector('.toggle-password');
    const passInputId = '{{ form.password.auto_id }}';
    const input = document.getElementById(passInputId);

    if (toggle && input) {
      toggle.addEventListener('click', () => {
        const isPwd = input.type === 'password';
        input.type = isPwd ? 'text' : 'password';
        toggle.innerHTML = isPwd
          ? '<i class="far fa-eye-slash"></i>'
          : '<i class="far fa-eye"></i>';
      });
    }
    
    const otpInput = document.getElementById('{{ form.otp_code.auto_id }}');
    if(otpInput) {
        otpInput.focus();
    }
  })();
</script>
{% endblock %}