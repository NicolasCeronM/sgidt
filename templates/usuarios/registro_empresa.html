{% extends "base_public.html" %} 
{% load static %} 
{% block title %}Registro Empresa - SGIDT{% endblock %}  
{% block css %}
<link
  rel="stylesheet"
  href="{% static 'usuarios/css/registro_persona.css' %}"
/>
{% endblock %} 

{% block content %}
<div class="reg-container">
  <!-- Header morado idéntico -->
  <div class="reg-header">
    <div class="reg-logo">SGIDT</div>
    <div class="reg-subtitle">Gestión tributaria, simple y clara</div>
    <div class="reg-features">
      <div class="feature">OCR de boletas y facturas</div>
      <div class="feature">Cálculo automático de IVA</div>
      <div class="feature">Validación con SII</div>
      <div class="feature">Reportes exportables</div>
    </div>
  </div>

  <div class="reg-formwrap">
    <div class="form-title">
      <h2>Crear cuenta de empresa</h2>
      <p>Registra tu empresa y crea la cuenta del representante</p>
    </div>

    {% if form.non_field_errors %}
    <div class="error-box" role="alert">
      {% for e in form.non_field_errors %}{{ e }}{% if not forloop.last %}
      <br />
      {%endif%} {% endfor %}
    </div>
    {% endif %}

    <form method="post" id="registroEmpresaForm" novalidate>
      {% csrf_token %}

      <!-- ===== Cuenta de usuario (representante) ===== -->
      <fieldset style="border: 0; padding: 0; margin: 0 0 0.75rem">
        <legend style="font-weight: 700; margin-bottom: 0.35rem">
          Cuenta de usuario
        </legend>

        <div class="form-row">
          <div class="form-group">
            <label for="{{ form.first_name.id_for_label }}">Nombres</label>
            {{ form.first_name }} {% if form.first_name.errors %}
            <div class="error-message django">
              {%for e in form.first_name.errors %} {{ e }} {%if not forloop.last%}
              <br />
              {%endif%} {%endfor%}
            </div>
            {% endif %}
          </div>
          <div class="form-group">
            <label for="{{ form.last_name.id_for_label }}">Apellidos</label>
            {{ form.last_name }} {% if form.last_name.errors %}
            <div class="error-message django">
              {% for e in form.last_name.errors %}{{ e }}{% if not forloop.last%}
              <br />
              {% endif %}{% endfor %}
            </div>
            {% endif %}
          </div>
        </div>

        <div class="form-group">
          <label for="{{ form.email.id_for_label }}">Email</label>
          {{ form.email }} {% if form.email.errors %}
          <div class="error-message django">
            {% for e in form.email.errors %}{{ e }}{% if not forloop.last %}<br />{%endif %}{% endfor %}
          </div>
          {% endif %}
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="{{ form.rut.id_for_label }}">RUT (representante)</label>
            {{ form.rut }} {% if form.rut.errors %}
            <div class="error-message django">
              {% for e in form.rut.errors %}{{ e }}{% if not forloop.last %}<br />{%endif %}{% endfor %}
            </div>
            {% endif %}
          </div>
          <div class="form-group">
            <label for="{{ form.telefono.id_for_label }}">Teléfono</label>
            {{ form.telefono }} {% if form.telefono.errors %}
            <div class="error-message django">
              {% for e in form.telefono.errors %}{{ e }}{% if not forloop.last%}<br />{% endif %}{% endfor %}
            </div>
            {% endif %}
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="{{ form.password1.id_for_label }}">Contraseña</label>
            {{ form.password1 }} {% if form.password1.errors %}
            <div class="error-message django">
              {% for e in form.password1.errors %}{{ e }}{% if not forloop.last%}<br />{% endif %}{% endfor %}
            </div>
            {% endif %}
          </div>
          <div class="form-group">
            <label for="{{ form.password2.id_for_label }}"
              >Confirmar contraseña</label
            >
            {{ form.password2 }} {% if form.password2.errors %}
            <div class="error-message django">
              {% for e in form.password2.errors %}{{ e }}{% if not forloop.last%}<br />{% endif %}{% endfor %}
            </div>
            {% endif %}
          </div>
        </div>
      </fieldset>

      <!-- ===== Datos de la empresa ===== -->
      <fieldset style="border: 0; padding: 0; margin-top: 0.75rem">
        <legend style="font-weight: 700; margin-bottom: 0.35rem">
          Datos empresa
        </legend>

        <div class="form-row">
          <div class="form-group">
            <label for="{{ form.empresa_rut.id_for_label }}">RUT empresa</label>
            {{ form.empresa_rut }} {% if form.empresa_rut.errors %}
            <div class="error-message django">
              {% for e in form.empresa_rut.errors %}{{ e }}{% if not forloop.last %}<br />{% endif %}{% endfor %}
            </div>
            {% endif %}
          </div>
          <div class="form-group">
            <label for="{{ form.razon_social.id_for_label }}"
              >Razón social</label
            >
            {{ form.razon_social }} {% if form.razon_social.errors %}
            <div class="error-message django">
              {% for e in form.razon_social.errors %}{{ e }}{% if not forloop.last %}<br />{% endif %}{% endfor %}
            </div>
            {% endif %}
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="{{ form.giro.id_for_label }}">Giro</label>
            {{ form.giro }}
          </div>
          <div class="form-group">
            <label for="{{ form.regimen.id_for_label }}">Régimen</label>
            {{ form.regimen }}
          </div>
        </div>

        <div class="form-group">
          <label for="{{ form.direccion.id_for_label }}">Dirección</label>
          {{ form.direccion }}
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="{{ form.comuna.id_for_label }}">Comuna</label>
            {{ form.comuna }}
          </div>
          <div class="form-group">
            <label for="{{ form.region.id_for_label }}">Región</label>
            {{ form.region }}
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="{{ form.contacto_email.id_for_label }}"
              >Email contacto</label
            >
            {{ form.contacto_email }}
          </div>
          <div class="form-group">
            <label for="{{ form.contacto_telefono.id_for_label }}"
              >Teléfono contacto</label
            >
            {{ form.contacto_telefono }}
          </div>
        </div>
      </fieldset>

      <button type="submit" class="submit-btn" id="submitBtn">
        <span id="btnText">Crear empresa y cuenta</span>
        <div class="loading" id="loading">
          <div class="spinner"></div>
        </div>
      </button>
    </form>

    <div class="login-link">
      <p>
        ¿Ya tienes cuenta?
        <a href="{% url 'usuarios:login' %}">Inicia sesión</a>
      </p>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  // Spinner al enviar si pasa validación nativa
  (function () {
    const form = document.getElementById("registroEmpresaForm");
    const btn = document.getElementById("submitBtn");
    const txt = document.getElementById("btnText");
    const load = document.getElementById("loading");
    if (!form) return;
    form.addEventListener("submit", function () {
      if (!form.checkValidity()) return;
      btn.disabled = true;
      txt.style.display = "none";
      load.style.display = "block";
    });
  })();

  // Formateo rápido de RUT y Teléfono (igual que en persona)
  (function () {
    document
      .querySelectorAll(
        '[name="{{ form.rut.html_name }}"], [name="{{ form.empresa_rut.html_name }}"]'
      )
      .forEach((input) => {
        input.setAttribute("data-mask", "rut");
      });
    document
      .querySelectorAll(
        '[name="{{ form.telefono.html_name }}"], [name="{{ form.contacto_telefono.html_name }}"]'
      )
      .forEach((input) => {
        input.setAttribute("data-mask", "phone");
      });

    // RUT #######-K con puntos
    document.querySelectorAll('[data-mask="rut"]').forEach((input) => {
      input.addEventListener("input", (e) => {
        let v = e.target.value.replace(/\D/g, "");
        if (v.length > 1) {
          const body = v.slice(0, -1);
          const dv = v.slice(-1);
          v = body.replace(/\B(?=(\d{3})+(?!\d))/g, ".") + "-" + dv;
        }
        e.target.value = v;
      });
    });

    // Teléfono simple formato CL
    document.querySelectorAll('[data-mask="phone"]').forEach((input) => {
      input.addEventListener("input", (e) => {
        let v = e.target.value.replace(/[^\d]/g, "");
        if (!v.startsWith("56")) v = "56" + v;
        const cc = "+" + v.slice(0, 2);
        const rest = v.slice(2);
        if (rest.length <= 1) e.target.value = `${cc} ${rest}`;
        else if (rest.length <= 2)
          e.target.value = `${cc} ${rest[0]} ${rest.slice(1)}`;
        else if (rest.length <= 6)
          e.target.value = `${cc} ${rest[0]} ${rest.slice(1, 5)} ${rest.slice(
            5
          )}`;
        else
          e.target.value = `${cc} ${rest[0]} ${rest.slice(1, 5)} ${rest.slice(
            5,
            9
          )} ${rest.slice(9, 13)}`;
      });
    });
  })();
</script>
{% endblock %}
